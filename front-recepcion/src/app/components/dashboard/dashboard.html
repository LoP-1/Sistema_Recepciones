<header class="masthead">
  <h1 class="title">Gestión de Trámites</h1>
</header>

<main id="mainContent" class="layout">
  <!-- FORMULARIO -->
  <section class="card form-zone" aria-labelledby="tituloForm">
    <div class="card-header">
      <h2 id="tituloForm" class="card-title">Registrar Trámite</h2>
    </div>

    <form [formGroup]="form" (ngSubmit)="registrar()" novalidate class="v-form">
      <div class="field-grid">
        <div class="field">
          <label for="fNombre">Nombre <span class="req">*</span></label>
          <input id="fNombre" formControlName="nombre"
                 [class.invalid]="form.controls.nombre.touched && form.controls.nombre.invalid" />
          <div class="error" *ngIf="form.controls.nombre.touched && form.controls.nombre.invalid">Requerido</div>
        </div>

        <div class="field">
          <label for="fDni">DNI <span class="req">*</span></label>
          <input id="fDni" formControlName="dni" (keyup.enter)="cargarTramitesPorDni()"
                 [class.invalid]="form.controls.dni.touched && form.controls.dni.invalid" />
          <div class="error" *ngIf="form.controls.dni.touched && form.controls.dni.invalid">Requerido</div>
        </div>

        <div class="field">
          <label for="fTelefono">Teléfono <span class="req">*</span></label>
          <input id="fTelefono" formControlName="telefono"
                 [class.invalid]="form.controls.telefono.touched && form.controls.telefono.invalid" />
          <div class="error" *ngIf="form.controls.telefono.touched && form.controls.telefono.invalid">Requerido</div>
        </div>

        <div class="field">
          <label for="fExpediente">N° Expediente <span class="req">*</span></label>
          <input id="fExpediente" #expedienteInput formControlName="expediente"
                 [class.invalid]="form.controls.expediente.touched && form.controls.expediente.invalid" />
          <div class="error" *ngIf="form.controls.expediente.touched && form.controls.expediente.invalid">Requerido</div>
        </div>

        <div class="field field-span-2">
          <label for="fDetalles">Descripción / Detalles <span class="req">*</span></label>
          <textarea id="fDetalles" rows="3" formControlName="detalles"
                    [class.invalid]="form.controls.detalles.touched && form.controls.detalles.invalid"></textarea>
          <div class="error" *ngIf="form.controls.detalles.touched && form.controls.detalles.invalid">Requerido</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" type="submit" [disabled]="form.invalid || loadingReg()" aria-label="Guardar trámite">
          <span *ngIf="!loadingReg()">Guardar</span>
          <span *ngIf="loadingReg()" class="inline-spinner" aria-hidden="true"></span>
        </button>
        <button class="btn outline" type="button" (click)="limpiarForm()">Limpiar</button>
      </div>

      <div *ngIf="mensajeRegistro()" class="alert" role="status" aria-live="polite">{{ mensajeRegistro() }}</div>
    </form>
  </section>

  <!-- PERSONAS -->
  <section class="card people-zone" aria-labelledby="tituloPersonas">
    <div class="card-header">
      <h2 id="tituloPersonas" class="card-title">Personas</h2>
    </div>

    <div class="field">
      <label for="fFiltro">Filtrar personas</label>
      <input id="fFiltro"
             type="text"
             placeholder="Nombre / Apellido / DNI"
             [value]="filtroPersonas()"
             (input)="onFiltroChange($any($event.target).value)"
             (keydown)="personasKeydown($event)"
             aria-controls="listaPersonas" />
    </div>

    <div *ngIf="personasLoading()" class="loading" aria-live="polite">
      <span class="inline-spinner" aria-hidden="true"></span> Cargando personas...
    </div>
    <div *ngIf="personasError()" class="alert error" role="alert">{{ personasError() }}</div>

    <ul id="listaPersonas" class="person-list" role="listbox" [attr.aria-busy]="personasLoading()">
      <li *ngFor="let p of personasPagina(); let i = index; trackBy: trackPersona"
          role="option"
          [attr.aria-selected]="personaSeleccionada()?.idPersona === p.idPersona"
          class="person-item"
          [class.selected]="personaSeleccionada()?.idPersona === p.idPersona"
          [class.active]="tecladoIndex() === i"
          (click)="seleccionarPersona(p)">
        <span class="person-name">{{ p.nombre }} {{ p.apellido }}</span>
        <span class="person-dni">DNI: {{ p.dni }}</span>
        <span *ngIf="p.telefono" class="person-tel">Tel: {{ p.telefono }}</span>
      </li>
      <li *ngIf="!personasPagina().length && !personasLoading()" class="empty">No hay resultados</li>
    </ul>

    <!-- Paginador ABAJO -->
    <div class="pagination-toolbar pagination-bottom" *ngIf="personasFiltradas().length">
      <nav class="pager" aria-label="Paginación personas">
        <button class="btn small ghost"
                (click)="changePage(-1)"
                [disabled]="currentPage() === 1"
                aria-label="Página anterior">‹</button>
        <span class="pager-info">Página {{ currentPage() }} de {{ totalPages() }}</span>
        <button class="btn small ghost"
                (click)="changePage(1)"
                [disabled]="currentPage() === totalPages()"
                aria-label="Página siguiente">›</button>
      </nav>
      <div class="page-size">
        <label for="selSize" class="visually-hidden">Elementos por página</label>
        <select id="selSize"
                [value]="pageSize()"
                (change)="setPageSize(+($any($event.target).value))"
                aria-label="Elementos por página">
          <option *ngFor="let opt of pageSizeOptions" [value]="opt">{{ opt }}/pág.</option>
        </select>
      </div>
    </div>
  </section>

  <!-- TRÁMITES -->
  <section class="card tramite-zone" aria-labelledby="tituloTramites">
    <div class="card-header">
      <h2 id="tituloTramites" class="card-title">
        Trámites de {{ personaSeleccionada()?.nombre || '...' }}
      </h2>
      <div class="toolbar">
        <label class="check">
          <input type="checkbox" [checked]="mostrarCompletados()" (change)="toggleCompletados()" />
          Mostrar completados
        </label>
        <button class="btn ghost small" (click)="refrescarTramites()" [disabled]="cargandoTramites()" aria-label="Refrescar trámites">⟳</button>
      </div>
    </div>

    <div *ngIf="!personaSeleccionada()" class="placeholder" aria-live="polite">
      Selecciona una persona para ver sus trámites.
    </div>

    <div *ngIf="cargandoTramites()" class="loading" aria-live="polite">
      <span class="inline-spinner" aria-hidden="true"></span> Cargando trámites...
    </div>

    <div *ngIf="personaSeleccionada() && !cargandoTramites() && tramitesFiltrados().length"
         class="table-wrapper table-wrapper--wide fade-in">
      <div class="table-scroll">
        <table class="data-table">
          <thead>
            <tr>
              <th class="col-id">ID</th>
              <th class="col-exp">Expediente</th>
              <th class="col-desc">Descripción</th>
              <th class="col-inicio">Inicio</th>
              <th class="col-fin">Fin</th>
              <th class="col-estado">Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of tramitesFiltrados(); trackBy: trackTramite"
                (click)="abrirDetalles(t.idTramite)" class="row-link" tabindex="0">
              <td class="col-id">{{ t.idTramite }}</td>
              <td class="col-exp">{{ t.nroExpediente }}</td>
              <td class="col-desc">
                <span class="truncate" [title]="t.descripcion">{{ t.descripcion }}</span>
              </td>
              <td class="col-inicio">{{ t.fechaInicio | date:'yyyy-MM-dd' }}</td>
              <td class="col-fin">{{ t.fechaFin ? (t.fechaFin | date:'yyyy-MM-dd') : '-' }}</td>
              <td class="col-estado">
                <span class="status" [class.done]="t.estado" [class.active]="!t.estado">
                  {{ t.estado ? 'Completado' : 'Activo' }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div *ngIf="personaSeleccionada() && !cargandoTramites() && !tramitesFiltrados().length" class="placeholder">
      No hay trámites para mostrar con el filtro actual.
    </div>
  </section>
</main>

<!-- Botón logout fijo esquina inferior derecha -->
<button class="btn danger btn-logout" (click)="logout()" aria-label="Cerrar sesión" title="Cerrar sesión">
  <span>Salir</span>
</button>