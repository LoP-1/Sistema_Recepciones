<header class="masthead">
  <h1 class="title">Gestión de Trámites</h1>
  <img src="logo-drej.png" alt="Logo DREJ" class="masthead-logo" />
</header>

<main id="mainContent" class="layout" tabindex="-1">
  <!-- Registro de trámites: formulario principal -->
  <section class="card form-zone" aria-labelledby="tituloForm">
    <div class="card-header">
      <h2 id="tituloForm" class="card-title">Registrar Trámite</h2>
    </div>

    <form [formGroup]="form" (ngSubmit)="registrar()" novalidate class="v-form" autocomplete="off">
      <div class="field-grid">
        <!-- Campo: Nombre -->
        <div class="field">
          <label for="fNombre">Nombre <span class="req" aria-hidden="true">*</span></label>
          <input id="fNombre"
                 formControlName="nombre"
                 autocomplete="off"
                 [attr.aria-invalid]="form.controls.nombre.invalid && form.controls.nombre.touched || null"
                 [class.invalid]="form.controls.nombre.touched && form.controls.nombre.invalid" />
          @if (form.controls.nombre.touched && form.controls.nombre.invalid) {
            <div class="error" id="errNombre">Requerido</div>
          }
        </div>
        <!-- Campo: DNI -->
        <div class="field">
          <label for="fDni">DNI <span class="req" aria-hidden="true">*</span></label>
            <input id="fDni"
                   formControlName="dni"
                   inputmode="numeric"
                   (keyup.enter)="cargarTramitesPorDni()"
                   [attr.aria-invalid]="form.controls.dni.invalid && form.controls.dni.touched || null"
                   [class.invalid]="form.controls.dni.touched && form.controls.dni.invalid" />
          @if (form.controls.dni.touched && form.controls.dni.invalid) {
            <div class="error" id="errDni">Requerido</div>
          }
        </div>
        <!-- Campo: Teléfono -->
        <div class="field">
          <label for="fTelefono">Teléfono <span class="req" aria-hidden="true">*</span></label>
          <input id="fTelefono"
                 formControlName="telefono"
                 inputmode="tel"
                 [attr.aria-invalid]="form.controls.telefono.invalid && form.controls.telefono.touched || null"
                 [class.invalid]="form.controls.telefono.touched && form.controls.telefono.invalid" />
          @if (form.controls.telefono.touched && form.controls.telefono.invalid) {
            <div class="error">Requerido</div>
          }
        </div>
        <!-- Campo: Expediente -->
        <div class="field">
          <label for="fExpediente">N° Expediente <span class="req" aria-hidden="true">*</span></label>
          <input id="fExpediente"
                 #expedienteInput
                 formControlName="expediente"
                 [attr.aria-invalid]="form.controls.expediente.invalid && form.controls.expediente.touched || null"
                 [class.invalid]="form.controls.expediente.touched && form.controls.expediente.invalid" />
          @if (form.controls.expediente.touched && form.controls.expediente.invalid) {
            <div class="error">Requerido</div>
          }
        </div>
         <div class="field">
  <label for="fFechaInicio">Fecha inicio</label>
  <input id="fFechaInicio"
         type="text"
         formControlName="fechaInicio"
         placeholder="Ej: 1989 - Enero" />
  <!-- No mostrar error de requerido aquí -->
</div>
<div class="field">
  <label for="fFechaFin">Fecha fin</label>
  <input id="fFechaFin"
         type="text"
         formControlName="fechaFin"
         placeholder="Ej: 2010 - Julio" />
</div>
        <!-- Campo: Detalles -->
        <div class="field field-span-2">
          <label for="fDetalles">Descripción / Detalles <span class="req" aria-hidden="true">*</span></label>
          <textarea id="fDetalles"
                    rows="3"
                    formControlName="detalles"
                    [attr.aria-invalid]="form.controls.detalles.invalid && form.controls.detalles.touched || null"
                    [class.invalid]="form.controls.detalles.touched && form.controls.detalles.invalid"></textarea>
          @if (form.controls.detalles.touched && form.controls.detalles.invalid) {
            <div class="error">Requerido</div>
          }
        </div>
       
      </div>

      <div class="actions">
        <button class="btn primary"
                type="submit"
                [disabled]="form.invalid || loadingReg()"
                aria-label="Guardar trámite">
          @if (!loadingReg()) { <span>Guardar</span> }
          @if (loadingReg()) { <span class="inline-spinner" aria-hidden="true"></span> }
        </button>
        <button class="btn outline" type="button" (click)="limpiarForm()">Limpiar</button>
        <button class="btn outline" type="button"
            (click)="actualizarDatos()"
            [disabled]="form.controls.nombre.invalid || form.controls.dni.invalid || form.controls.telefono.invalid || loadingActualizar()">
          @if (!loadingActualizar()) { <span>Actualizar datos</span> }
          @if (loadingActualizar()) { <span class="inline-spinner" aria-hidden="true"></span> }
        </button>
      </div>

      @if (mensajeRegistro()) {
        <div class="alert" role="status" aria-live="polite">{{ mensajeRegistro() }}</div>
      }
    </form>
  </section>

  <!-- Listado de personas con filtro y paginación -->
  <section class="card people-zone" aria-labelledby="tituloPersonas">
    <div class="card-header">
      <h2 id="tituloPersonas" class="card-title">Personas</h2>
    </div>

    <div class="field">
      <label for="fFiltro">Filtrar personas</label>
      <input id="fFiltro"
             type="text"
             placeholder="Nombre / Apellido / DNI"
             [value]="filtroPersonas()"
             (input)="onFiltroChange($event.target.value)"
             (keydown)="personasKeydown($event)"
             aria-controls="listaPersonas"
             autocomplete="off" />
    </div>

    @if (personasLoading()) {
      <div class="loading" aria-live="polite">
        <span class="inline-spinner" aria-hidden="true"></span> Cargando personas...
      </div>
    }
    @if (personasError()) {
      <div class="alert error" role="alert">{{ personasError() }}</div>
    }

    <ul id="listaPersonas"
        class="person-list"
        role="listbox"
        [attr.aria-busy]="personasLoading()"
        [attr.aria-label]="'Listado de personas filtradas'">
      @for (p of personasPagina(); track p.idPersona; let i = $index) {
        <li role="option"
            class="person-item"
            [class.selected]="personaSeleccionada()?.idPersona === p.idPersona"
            [class.active]="tecladoIndex() === i"
            (click)="seleccionarPersona(p)"
            [attr.aria-selected]="personaSeleccionada()?.idPersona === p.idPersona"
            [id]="'persona-'+p.idPersona">
          <span class="person-name">{{ p.nombre }} {{ p.apellido }}</span>
          <span class="person-dni">DNI: {{ p.dni }}</span>
          @if (p.telefono) {
            <span class="person-tel">Tel: {{ p.telefono }}</span>
          }
        </li>
      }
      @if (!personasPagina().length && !personasLoading()) {
        <li class="empty" aria-live="polite">No hay resultados</li>
      }
    </ul>

    @if (personasFiltradas().length) {
      <div class="pagination-toolbar pagination-bottom">
        <nav class="pager" aria-label="Paginación personas">
          <button class="btn small ghost"
                  (click)="changePage(-1)"
                  [disabled]="currentPage() === 1"
                  aria-label="Página anterior">‹</button>
          <span class="pager-info">Página {{ currentPage() }} de {{ totalPages() }}</span>
          <button class="btn small ghost"
                  (click)="changePage(1)"
                  [disabled]="currentPage() === totalPages()"
                  aria-label="Página siguiente">›</button>
        </nav>
        <div class="page-size">
          <label for="selSize" class="visually-hidden">Elementos por página</label>
          <select id="selSize"
                  [value]="pageSize()"
                  (change)="setPageSize(+($any($event.target).value))"
                  aria-label="Elementos por página">
            @for (opt of pageSizeOptions; track opt) {
              <option [value]="opt">{{ opt }}/pág.</option>
            }
          </select>
        </div>
      </div>
    }
  </section>

  <!-- Tabla de trámites por persona seleccionada -->
  <section class="card tramite-zone" aria-labelledby="tituloTramites">
    <div class="tramite-filtros">
  <div class="field">
    <label for="fFiltroExp">Buscar por expediente</label>
    <input id="fFiltroExp"
           type="text"
           placeholder="N° expediente"
           [value]="filtroExpediente()"
           (input)="filtroExpediente.set($event.target.value)" />
  </div>
  <div class="field">
    <label for="fFiltroIni">Año inicio</label>
    <input id="fFiltroIni"
           type="text"
           placeholder="Ej: 2000"
           [value]="filtroFechaInicio()"
           (input)="filtroFechaInicio.set($event.target.value)" />
  </div>
  <div class="field">
    <label for="fFiltroFin">Año fin</label>
    <input id="fFiltroFin"
           type="text"
           placeholder="Ej: 2024"
           [value]="filtroFechaFin()"
           (input)="filtroFechaFin.set($event.target.value)" />
  </div>
</div>
    <div class="card-header">
      <h2 id="tituloTramites" class="card-title">
        Trámites de {{ personaSeleccionada()?.nombre || '...' }}
      </h2>
      <div class="toolbar">
        <label class="check">
          <input type="checkbox"
                 [checked]="mostrarCompletados()"
                 (change)="toggleCompletados()" />
          Mostrar completados
        </label>
        <button class="btn ghost small"
                (click)="refrescarTramites()"
                [disabled]="cargandoTramites()"
                aria-label="Refrescar trámites">⟳</button>
      </div>
    </div>

    @if (!personaSeleccionada()) {
      <div class="placeholder" aria-live="polite">
        Selecciona una persona para ver sus trámites.
      </div>
    }

    @if (cargandoTramites()) {
      <div class="loading" aria-live="polite">
        <span class="inline-spinner" aria-hidden="true"></span> Cargando trámites...
      </div>
    }

    @if (personaSeleccionada() && !cargandoTramites() && tramitesFiltrados().length) {
      <div class="table-wrapper table-wrapper--wide fade-in">
        <div class="table-scroll">
          <table class="data-table" role="table">
            <caption class="visually-hidden">Listado de trámites de la persona seleccionada</caption>
            <thead>
              <tr>
                <th scope="col" class="col-id">ID</th>
                <th scope="col" class="col-exp">Expediente</th>
                <th scope="col" class="col-desc">Descripción</th>
                <th scope="col" class="col-inicio">Inicio</th>
                <th scope="col" class="col-fin">Fin</th>
                <th scope="col" class="col-estado">Estado</th>
              </tr>
            </thead>
            <tbody>
              @for (t of tramitesFiltradosTabla(); track t.idTramite) {
                <tr (click)="abrirDetalles(t.idTramite)"
                    class="row-link"
                    tabindex="0"
                    (keydown.enter)="abrirDetalles(t.idTramite)">
                  <td class="col-id">{{ t.idTramite }}</td>
                  <td class="col-exp">{{ t.nroExpediente }}</td>
                  <td class="col-desc">
                    <span class="truncate" [title]="t.descripcion">{{ t.descripcion }}</span>
                  </td>
                  <td class="col-inicio">{{ t.fechaInicio | date:'yyyy-MM-dd' }}</td>
                  <td class="col-fin">{{ t.fechaFin ? (t.fechaFin | date:'yyyy-MM-dd') : '-' }}</td>
                  <td class="col-estado">
                    <span class="status"
                          [class.status--completado]="t.estado"
                          [class.status--activo]="!t.estado">
                      {{ t.estado ? 'Completado' : 'Activo' }}
                    </span>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }

    @if (personaSeleccionada() && !cargandoTramites() && !tramitesFiltrados().length) {
      <div class="placeholder">
        No hay trámites para mostrar con el filtro actual.
      </div>
    }
  </section>
</main>

<!-- Botón de cierre de sesión -->
<button class="btn danger btn-logout"
        (click)="logout()"
        aria-label="Cerrar sesión"
        title="Cerrar sesión">
  <span>Salir</span>
</button>