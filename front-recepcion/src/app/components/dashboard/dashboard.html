<app-navbar title="Gestión de Trámites"></app-navbar>

<main id="mainContent" aria-label="Panel principal de gestión">

  <!-- Panel Formulario -->
  <mat-card appearance="outlined">
    <mat-card-header>
      <mat-card-title id="tituloForm">Registrar Trámite</mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <form [formGroup]="form" (ngSubmit)="registrar()" novalidate class="form-container">
        <mat-form-field appearance="outline">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="nombre" autocomplete="off" />
          <mat-error *ngIf="form.controls.nombre.invalid && form.controls.nombre.touched">
            Requerido
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>DNI</mat-label>
          <input matInput formControlName="dni" (keyup.enter)="cargarTramitesPorDni()" inputmode="numeric" />
          <mat-error *ngIf="form.controls.dni.invalid && form.controls.dni.touched">
            Requerido
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Teléfono</mat-label>
          <input matInput formControlName="telefono" inputmode="tel" />
          <mat-error *ngIf="form.controls.telefono.invalid && form.controls.telefono.touched">
            Requerido
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>N° Expediente</mat-label>
          <input #expedienteInput matInput formControlName="expediente" />
          <mat-error *ngIf="form.controls.expediente.invalid && form.controls.expediente.touched">
            Requerido
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Descripción / Detalles</mat-label>
          <textarea matInput rows="3" formControlName="detalles"></textarea>
          <mat-error *ngIf="form.controls.detalles.invalid && form.controls.detalles.touched">
            Requerido
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>DNI Encargado</mat-label>
          <input matInput formControlName="dniEncargado" />
          <mat-error *ngIf="form.controls.dniEncargado.invalid && form.controls.dniEncargado.touched">
            Requerido
          </mat-error>
        </mat-form-field>

        <div class="button-container">
          <button mat-raised-button color="primary" type="submit" 
                  [disabled]="form.invalid || loadingReg()" 
                  aria-label="Guardar trámite">
            <mat-icon *ngIf="loadingReg()">hourglass_empty</mat-icon>
            {{ loadingReg() ? 'Guardando...' : 'Guardar' }}
          </button>
          <button mat-stroked-button type="button" (click)="limpiarForm()" 
                  aria-label="Limpiar formulario">
            <mat-icon>clear</mat-icon>
            Limpiar
          </button>
        </div>

        <mat-card *ngIf="mensajeRegistro()" class="message-card">
          <mat-card-content>
            {{ mensajeRegistro() }}
          </mat-card-content>
        </mat-card>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Panel Personas -->
  <mat-card appearance="outlined">
    <mat-card-header>
      <mat-card-title id="tituloPersonas">Personas</mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Filtrar personas</mat-label>
        <input matInput
               type="text"
               placeholder="Filtrar por nombre / apellido / DNI"
               [value]="filtroPersonas()"
               (input)="onFiltroChange($event.target.value)"
               (keydown)="personasKeydown($event)"
               aria-controls="listaPersonas" />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <div *ngIf="personasLoading()" class="loading-container">
        <mat-spinner diameter="30"></mat-spinner>
        <span>Cargando personas...</span>
      </div>

      <mat-card *ngIf="personasError()" color="warn" class="error-card">
        <mat-card-content>
          <mat-icon>error</mat-icon>
          {{ personasError() }}
        </mat-card-content>
      </mat-card>

      <mat-selection-list #personasListBox
                          id="listaPersonas"
                          [multiple]="false"
                          aria-label="Listado de personas"
                          class="personas-list">
        <mat-list-option *ngFor="let p of personasFiltradas(); let i = index; trackBy: trackPersona"
                         [value]="p"
                         [selected]="personaSeleccionada()?.idPersona === p.idPersona"
                         (click)="seleccionarPersona(p)">
          <div class="persona-item">
            <div class="persona-name">{{ p.nombre }} {{ p.apellido }}</div>
            <div class="persona-details">
              <span class="dni">DNI: {{ p.dni }}</span>
              <span *ngIf="p.telefono" class="telefono">Tel: {{ p.telefono }}</span>
            </div>
          </div>
        </mat-list-option>

        <mat-list-option *ngIf="!personasFiltradas().length && !personasLoading()" disabled>
          <span class="no-results">No hay resultados.</span>
        </mat-list-option>
      </mat-selection-list>
    </mat-card-content>
  </mat-card>

  <!-- Panel Trámites -->
  <mat-card appearance="outlined">
    <mat-card-header>
      <mat-card-title id="tituloTramites">
        Trámites de {{ personaSeleccionada()?.nombre || '...' }}
      </mat-card-title>
      <mat-card-subtitle>
        <div class="tramites-controls">
          <mat-checkbox
                   [checked]="mostrarCompletados()"
                   (change)="toggleCompletados()"
                   aria-controls="tablaTramites">
            Mostrar completados
          </mat-checkbox>
          <button mat-icon-button
                  (click)="refrescarTramites()"
                  [disabled]="cargandoTramites()"
                  aria-label="Refrescar trámites de la persona seleccionada"
                  matTooltip="Refrescar trámites">
            <mat-icon>refresh</mat-icon>
          </button>
        </div>
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div *ngIf="!personaSeleccionada()" class="empty-state">
        <mat-icon>person_outline</mat-icon>
        <p>Selecciona una persona para ver sus trámites.</p>
      </div>

      <div *ngIf="cargandoTramites()" class="loading-container">
        <mat-spinner diameter="30"></mat-spinner>
        <span>Cargando trámites...</span>
      </div>

      <div *ngIf="personaSeleccionada() && !cargandoTramites() && tramitesFiltrados().length"
           class="table-container">
        <table mat-table [dataSource]="tramitesFiltrados()" id="tablaTramites" class="tramites-table">
          
          <ng-container matColumnDef="idTramite">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let tramite">{{ tramite.idTramite }}</td>
          </ng-container>

          <ng-container matColumnDef="nroExpediente">
            <th mat-header-cell *matHeaderCellDef>Expediente</th>
            <td mat-cell *matCellDef="let tramite">{{ tramite.nroExpediente }}</td>
          </ng-container>

          <ng-container matColumnDef="descripcion">
            <th mat-header-cell *matHeaderCellDef>Descripción</th>
            <td mat-cell *matCellDef="let tramite">{{ tramite.descripcion }}</td>
          </ng-container>

          <ng-container matColumnDef="fechaInicio">
            <th mat-header-cell *matHeaderCellDef>Inicio</th>
            <td mat-cell *matCellDef="let tramite">{{ tramite.fechaInicio | date:'yyyy-MM-dd' }}</td>
          </ng-container>

          <ng-container matColumnDef="fechaFin">
            <th mat-header-cell *matHeaderCellDef>Fin</th>
            <td mat-cell *matCellDef="let tramite">{{ tramite.fechaFin ? (tramite.fechaFin | date:'yyyy-MM-dd') : '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="estado">
            <th mat-header-cell *matHeaderCellDef>Estado</th>
            <td mat-cell *matCellDef="let tramite">
              <mat-chip-set>
                <mat-chip [color]="tramite.estado ? 'accent' : 'primary'" selected>
                  {{ tramite.estado ? 'Completado' : 'Activo' }}
                </mat-chip>
              </mat-chip-set>
            </td>
          </ng-container>

          <!-- Fila con click para abrir detalles -->
          <tr mat-row 
              *matRowDef="let row; columns: displayedColumns;"
              (click)="abrirDetalles(row.idTramite)">
          </tr>
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        </table>
      </div>

      <div *ngIf="personaSeleccionada() && !cargandoTramites() && !tramitesFiltrados().length"
           class="empty-state">
        <mat-icon>assignment</mat-icon>
        <p>No hay trámites para mostrar con el filtro actual.</p>
      </div>
    </mat-card-content>
  </mat-card>
</main>