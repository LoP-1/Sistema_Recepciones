<div class="fixed inset-0 z-50 overflow-hidden bg-black/50 backdrop-blur-sm animate-fade-in">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl max-h-[95vh] overflow-hidden flex flex-col animate-scale-in">
      
      <!-- Header -->
      <header class="bg-gradient-primary px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center backdrop-blur-sm">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <h2 class="text-xl font-bold text-white">Agregar Detalles / Evidencias</h2>
        </div>
        <div class="flex items-center gap-2">
          <!-- Botón Imprimir -->
          <button
            type="button"
            class="p-2.5 rounded-lg bg-white/20 hover:bg-white/30 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed group relative"
            aria-label="Imprimir constancia del trámite"
            (click)="ImprimirTramite()"
            [disabled]="!historial().length">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            <span class="absolute -bottom-8 right-0 bg-gray-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
              Imprimir
            </span>
          </button>
          <!-- Botón Cerrar -->
          <button
            type="button"
            class="p-2.5 rounded-lg bg-white/20 hover:bg-white/30 transition-all duration-200"
            (click)="cerrar()"
            aria-label="Cerrar">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </header>

      <!-- Body con Grid Responsivo -->
      <div class="flex-1 overflow-hidden">
        <div class="h-full grid grid-cols-1 lg:grid-cols-2 gap-0">
          
          <!-- Columna Izquierda: Formulario -->
          <div class="overflow-y-auto p-6 bg-gradient-to-br from-slate-50 to-primary-50">
            <form [formGroup]="form" (ngSubmit)="guardar()" novalidate class="space-y-6">
              
              <!-- Tipo de Proceso -->
              <div class="space-y-2">
                <label for="fTipoProceso" class="flex items-center gap-2 text-sm font-semibold text-slate-700">
                  <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                  </svg>
                  Tipo Proceso <span class="text-danger-500">*</span>
                </label>
                <select 
                  id="fTipoProceso" 
                  formControlName="tipoProceso"
                  class="w-full px-4 py-2.5 rounded-lg border transition-all duration-200 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none bg-white"
                  [class.border-slate-300]="!(form.controls.tipoProceso.touched && form.controls.tipoProceso.invalid)"
                  [class.border-danger-500]="form.controls.tipoProceso.touched && form.controls.tipoProceso.invalid"
                  [class.bg-danger-50]="form.controls.tipoProceso.touched && form.controls.tipoProceso.invalid">
                  @for (t of tiposProceso; track t) {
                    <option [value]="t">{{ t }}</option>
                  }
                </select>
                @if (form.controls.tipoProceso.touched && form.controls.tipoProceso.invalid) {
                  <p class="text-sm text-danger-600 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    Campo requerido
                  </p>
                }
              </div>

              <!-- Campo Personalizado (condicional) -->
              @if (form.value.tipoProceso === 'Personalizado') {
                <div class="space-y-2 animate-slide-down">
                  <label for="fCustomTipoProceso" class="flex items-center gap-2 text-sm font-semibold text-slate-700">
                    <svg class="w-4 h-4 text-secondary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    Nombre personalizado <span class="text-danger-500">*</span>
                  </label>
                  <input 
                    id="fCustomTipoProceso" 
                    formControlName="customTipoProceso"
                    placeholder="Ej: Proceso especial"
                    class="w-full px-4 py-2.5 rounded-lg border transition-all duration-200 focus:ring-2 focus:ring-secondary-500 focus:border-secondary-500 outline-none"
                    [class.border-slate-300]="!(form.controls.customTipoProceso.touched && form.controls.customTipoProceso.invalid)"
                    [class.border-danger-500]="form.controls.customTipoProceso.touched && form.controls.customTipoProceso.invalid"
                    [class.bg-danger-50]="form.controls.customTipoProceso.touched && form.controls.customTipoProceso.invalid" />
                  @if (form.controls.customTipoProceso.touched && form.controls.customTipoProceso.invalid) {
                    <p class="text-sm text-danger-600 flex items-center gap-1">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                      </svg>
                      Campo requerido
                    </p>
                  }
                </div>
              }

              <!-- Detalles -->
              <div class="space-y-2">
                <label for="fDetalles" class="flex items-center gap-2 text-sm font-semibold text-slate-700">
                  <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  Detalles / Descripción <span class="text-danger-500">*</span>
                </label>
                <textarea 
                  id="fDetalles" 
                  rows="4" 
                  formControlName="detalles" 
                  placeholder="Ej: Se adjunta boleta escaneada..."
                  class="w-full px-4 py-2.5 rounded-lg border transition-all duration-200 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none resize-none"
                  [class.border-slate-300]="!(form.controls.detalles.touched && form.controls.detalles.invalid)"
                  [class.border-danger-500]="form.controls.detalles.touched && form.controls.detalles.invalid"
                  [class.bg-danger-50]="form.controls.detalles.touched && form.controls.detalles.invalid"></textarea>
                @if (form.controls.detalles.touched && form.controls.detalles.invalid) {
                  <p class="text-sm text-danger-600 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    Mínimo 5 caracteres
                  </p>
                }
              </div>

              <!-- Campos Condicionales: Boleta y Monto -->
              @if (form.value.tipoProceso === 'Adjunto' || form.value.tipoProceso === 'Personalizado') {
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 animate-slide-down">
                  <div class="space-y-2">
                    <label for="fBoleta" class="flex items-center gap-2 text-sm font-semibold text-slate-700">
                      <svg class="w-4 h-4 text-success-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      Boleta (opcional)
                    </label>
                    <input 
                      id="fBoleta" 
                      formControlName="boleta" 
                      placeholder="Número de boleta"
                      class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-success-500 focus:border-success-500 outline-none transition-all duration-200" />
                  </div>
                  <div class="space-y-2">
                    <label for="fMonto" class="flex items-center gap-2 text-sm font-semibold text-slate-700">
                      <svg class="w-4 h-4 text-success-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      Monto (opcional)
                    </label>
                    <input 
                      id="fMonto" 
                      type="number" 
                      min="0" 
                      step="0.01"
                      formControlName="monto" 
                      placeholder="Ej: 100.00"
                      class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-success-500 focus:border-success-500 outline-none transition-all duration-200" />
                  </div>
                </div>
              }

              <!-- Zona de Adjuntar Archivo -->
              <div class="space-y-2">
                <h3 class="flex items-center gap-2 text-sm font-semibold text-slate-700">
                  <svg class="w-4 h-4 text-warning-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                  </svg>
                  Adjuntar Archivo (Opcional)
                </h3>
                
                <div 
                  class="border-2 border-dashed rounded-xl p-8 transition-all duration-200"
                  [class.border-slate-300]="!cargando()"
                  [class.bg-slate-50]="!cargando()"
                  [class.border-primary-400]="cargando()"
                  [class.bg-primary-50]="cargando()"
                  fileDrop 
                  (fileDropped)="onFileDropped($event)">
                  
                  @if (!archivo()) {
                    <div class="flex flex-col items-center gap-3 text-center">
                      <div class="w-16 h-16 bg-gradient-primary rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                      </div>
                      <div>
                        <p class="text-slate-600 font-medium">Arrastra y suelta tu archivo aquí</p>
                        <p class="text-sm text-slate-500 mt-1">o</p>
                      </div>
                      <label class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-primary hover:opacity-90 text-white font-medium rounded-lg cursor-pointer transition-all duration-200 shadow-md hover:shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        Seleccionar archivo
                        <input type="file" (change)="onFileInputChange($event)" hidden />
                      </label>
                      <p class="text-xs text-slate-500">Máximo {{ (maxSizeBytes / (1024*1024)).toFixed(1) }} MB</p>
                    </div>
                  } @else {
                    <div class="space-y-4">
                      <!-- Info del archivo -->
                      <div class="flex items-start gap-3 p-4 bg-white rounded-lg border border-slate-200">
                        <div class="flex-shrink-0 w-10 h-10 bg-gradient-secondary rounded-lg flex items-center justify-center">
                          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                          </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                          <p class="font-semibold text-slate-800 truncate">{{ archivo()!.nombre }}</p>
                          <p class="text-sm text-slate-500">{{ archivo()!.tipo }} • {{ archivo()!.tamanoKb }} KB</p>
                        </div>
                      </div>

                      <!-- Preview de Imagen -->
                      @if (archivo()!.esImagen && archivo()!.base64) {
                        <div class="relative rounded-lg overflow-hidden border border-slate-200">
                          <img [src]="archivo()!.base64" alt="Vista previa" class="w-full h-auto max-h-64 object-contain bg-slate-100" />
                        </div>
                      }

                      <!-- Preview de PDF -->
                      @if (archivo()!.tipo === 'application/pdf') {
                        <div class="space-y-2">
                          @if (!archivo()!.cargaFallida) {
                            <div class="relative rounded-lg overflow-hidden border border-slate-200 bg-slate-100">
                              <iframe 
                                class="w-full h-96" 
                                [src]="archivo()!.safeUrl" 
                                title="Vista previa PDF"
                                (error)="marcarIframeError()" 
                                (load)="logExitoPDF()"></iframe>
                            </div>
                          } @else {
                            <div class="p-8 bg-warning-50 border border-warning-200 rounded-lg text-center">
                              <svg class="w-12 h-12 mx-auto text-warning-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                              </svg>
                              <p class="text-warning-800 font-medium mb-3">No se puede mostrar el PDF</p>
                              <button type="button" class="px-4 py-2 bg-warning-600 hover:bg-warning-700 text-white rounded-lg font-medium transition-colors" (click)="abrirEnNuevaPestana()">
                                Abrir en nueva pestaña
                              </button>
                            </div>
                          }
                          <div class="flex gap-2">
                            <button type="button" class="flex-1 px-4 py-2 bg-white border border-slate-300 hover:bg-slate-50 rounded-lg font-medium text-sm transition-colors" (click)="abrirEnNuevaPestana()">
                              Nueva pestaña
                            </button>
                            <button type="button" class="flex-1 px-4 py-2 bg-white border border-slate-300 hover:bg-slate-50 rounded-lg font-medium text-sm transition-colors" (click)="abrirSuper()">
                              Ver grande
                            </button>
                          </div>
                        </div>
                      }

                      <!-- Archivo genérico -->
                      @if (!archivo()!.esImagen && archivo()!.tipo !== 'application/pdf') {
                        <div class="p-8 bg-slate-100 rounded-lg text-center">
                          <svg class="w-16 h-16 mx-auto text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                          </svg>
                          <button type="button" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors" (click)="abrirEnNuevaPestana()">
                            Abrir / Descargar
                          </button>
                        </div>
                      }

                      <!-- Acciones -->
                      <div class="flex gap-2">
                        <button type="button" class="flex-1 px-4 py-2 bg-danger-600 hover:bg-danger-700 text-white rounded-lg font-medium transition-colors" (click)="quitarArchivo()">
                          Quitar archivo
                        </button>
                        <label class="flex-1 px-4 py-2 bg-white border-2 border-slate-300 hover:bg-slate-50 text-slate-700 rounded-lg font-medium transition-colors cursor-pointer text-center">
                          Cambiar
                          <input type="file" (change)="onFileInputChange($event)" hidden />
                        </label>
                      </div>
                    </div>
                  }
                </div>
              </div>

              <!-- Mensaje de feedback -->
              @if (mensaje()) {
                <div 
                  class="p-4 rounded-lg flex items-start gap-3 animate-fade-in"
                  [class.bg-danger-50]="esError()"
                  [class.border-danger-200]="esError()"
                  [class.bg-success-50]="!esError()"
                  [class.border-success-200]="!esError()"
                  [class.border]="true"
                  role="status" 
                  aria-live="polite">
                  @if (esError()) {
                    <svg class="w-5 h-5 text-danger-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                  } @else {
                    <svg class="w-5 h-5 text-success-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                  }
                  <span 
                    class="text-sm font-medium"
                    [class.text-danger-800]="esError()"
                    [class.text-success-800]="!esError()">
                    {{ mensaje() }}
                  </span>
                </div>
              }

            </form>
          </div>

          <!-- Columna Derecha: Línea de Tiempo -->
          <div class="overflow-y-auto bg-white border-l border-slate-200">
            <div class="sticky top-0 bg-gradient-accent px-6 py-4 z-10 shadow-md">
              <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Línea de Tiempo
              </h3>
            </div>

            <div class="p-6">
              @if (cargandoHistorial()) {
                <div class="flex items-center justify-center py-12" aria-live="polite">
                  <svg class="animate-spin h-8 w-8 text-accent-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <span class="ml-3 text-slate-600">Cargando historial...</span>
                </div>
              }

              @if (!cargandoHistorial() && !historial().length) {
                <div class="flex flex-col items-center justify-center py-16">
                  <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>
                  <p class="text-slate-500 text-center">Sin historial de procesos</p>
                </div>
              }

              <!-- Timeline Items -->
              <div class="relative">
                <!-- Línea vertical continua -->
                @if (historial().length) {
                  <div class="absolute left-6 top-0 bottom-0 w-0.5 bg-gradient-to-b from-accent-500 via-primary-500 to-secondary-500"></div>
                }

                <ul class="space-y-6 relative">
                  @for (item of historial(); track item.id; let first = $first; let last = $last) {
                    <li class="relative pl-16 animate-slide-in" [style.animation-delay]="$index * 0.05 + 's'">
                      <!-- Punto en la línea -->
                      <div 
                        class="absolute left-0 w-12 h-12 rounded-full flex items-center justify-center shadow-lg z-10"
                        [class.bg-gradient-to-br]="true"
                        [class.from-success-400]="item.tipoProceso === 'Finalizado'"
                        [class.to-success-600]="item.tipoProceso === 'Finalizado'"
                        [class.from-primary-400]="item.tipoProceso === 'Iniciado'"
                        [class.to-primary-600]="item.tipoProceso === 'Iniciado'"
                        [class.from-secondary-400]="item.tipoProceso === 'Adjunto'"
                        [class.to-secondary-600]="item.tipoProceso === 'Adjunto'"
                        [class.from-warning-400]="item.tipoProceso !== 'Finalizado' && item.tipoProceso !== 'Iniciado' && item.tipoProceso !== 'Adjunto'"
                        [class.to-warning-600]="item.tipoProceso !== 'Finalizado' && item.tipoProceso !== 'Iniciado' && item.tipoProceso !== 'Adjunto'">
                        @if (item.tipoProceso === 'Finalizado') {
                          <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                          </svg>
                        } @else if (item.tipoProceso === 'Iniciado') {
                          <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                          </svg>
                        } @else if (item.tipoProceso === 'Adjunto') {
                          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                          </svg>
                        } @else {
                          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                          </svg>
                        }
                      </div>

                      <!-- Contenido de la tarjeta -->
                      <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 border border-slate-200 overflow-hidden">
                        <div class="p-4 space-y-3">
                          <!-- Header con fecha y badge -->
                          <div class="flex items-start justify-between gap-2 flex-wrap">
                            <div class="flex items-center gap-2 text-sm text-slate-500">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              <span class="font-medium">{{ item.fechaProceso | date:'dd/MM/yyyy HH:mm' }}</span>
                            </div>
                            <span 
                              class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold"
                              [class.bg-success-100]="item.tipoProceso === 'Finalizado'"
                              [class.text-success-800]="item.tipoProceso === 'Finalizado'"
                              [class.bg-primary-100]="item.tipoProceso === 'Iniciado'"
                              [class.text-primary-800]="item.tipoProceso === 'Iniciado'"
                              [class.bg-secondary-100]="item.tipoProceso === 'Adjunto'"
                              [class.text-secondary-800]="item.tipoProceso === 'Adjunto'"
                              [class.bg-warning-100]="item.tipoProceso !== 'Finalizado' && item.tipoProceso !== 'Iniciado' && item.tipoProceso !== 'Adjunto'"
                              [class.text-warning-800]="item.tipoProceso !== 'Finalizado' && item.tipoProceso !== 'Iniciado' && item.tipoProceso !== 'Adjunto'">
                              {{ item.tipoProceso }}
                            </span>
                          </div>

                          <!-- Detalles -->
                          <p class="text-slate-700 text-sm leading-relaxed">{{ item.detalles }}</p>

                          <!-- Boleta y Monto -->
                          @if (item.boleta || (item.monto != null && item.monto !== undefined)) {
                            <div class="flex flex-wrap gap-4 pt-2 border-t border-slate-100">
                              @if (item.boleta) {
                                <div class="flex items-center gap-2 text-sm">
                                  <svg class="w-4 h-4 text-accent-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                  </svg>
                                  <span class="font-semibold text-slate-700">Boleta:</span>
                                  <span class="text-slate-600">{{ item.boleta }}</span>
                                </div>
                              }
                              @if (item.monto != null && item.monto !== undefined) {
                                <div class="flex items-center gap-2 text-sm">
                                  <svg class="w-4 h-4 text-success-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                  </svg>
                                  <span class="font-semibold text-slate-700">Monto:</span>
                                  <span class="text-slate-600">S/. {{ item.monto }}</span>
                                </div>
                              }
                            </div>
                          }

                          <!-- Archivo adjunto -->
                          @if (item.nombreArchivo) {
                            <div class="pt-2 border-t border-slate-100">
                              <div class="flex items-center justify-between gap-2 p-3 bg-slate-50 rounded-lg">
                                <div class="flex items-center gap-2 flex-1 min-w-0">
                                  <svg class="w-5 h-5 text-primary-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                                  </svg>
                                  <span class="text-sm font-medium text-slate-700 truncate">{{ item.nombreArchivo }}</span>
                                </div>
                                <button 
                                  type="button" 
                                  class="px-3 py-1.5 bg-primary-600 hover:bg-primary-700 text-white text-xs font-medium rounded-lg transition-colors flex-shrink-0"
                                  (click)="descargarAdjunto(item)">
                                  Descargar
                                </button>
                              </div>
                            </div>
                          }
                        </div>
                      </div>
                    </li>
                  }
                </ul>
              </div>

              <!-- Botones de Acción (sticky al fondo) -->
              <div class="sticky bottom-0 bg-white pt-6 pb-2 mt-6 border-t border-slate-200 space-y-3">
                <button 
                  type="button" 
                  class="w-full px-4 py-3 bg-gradient-primary hover:opacity-90 text-white font-semibold rounded-lg transition-all duration-200 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  [disabled]="form.invalid || cargando()" 
                  (click)="guardar()">
                  @if (!cargando()) {
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>Guardar</span>
                  }
                  @if (cargando()) {
                    <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Guardando...</span>
                  }
                </button>

                <button 
                  type="button" 
                  class="w-full px-4 py-3 bg-white hover:bg-slate-50 text-slate-700 font-semibold rounded-lg border-2 border-slate-300 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                  (click)="limpiarTodo()" 
                  [disabled]="cargando()">
                  Limpiar
                </button>

                <button 
                  type="button" 
                  class="w-full px-4 py-3 bg-gradient-warning hover:opacity-90 text-white font-semibold rounded-lg transition-all duration-200 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  [disabled]="form.controls.tipoProceso.invalid || cargandoFinalizar()"
                  (click)="finalizarTramiteClick()">
                  @if (!cargandoFinalizar()) {
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>Finalizar Trámite</span>
                  }
                  @if (cargandoFinalizar()) {
                    <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Finalizando...</span>
                  }
                </button>

                <button 
                  type="button" 
                  class="w-full px-4 py-3 bg-gradient-accent hover:opacity-90 text-white font-semibold rounded-lg transition-all duration-200 shadow-md hover:shadow-lg"
                  (click)="cerrar()">
                  Cerrar
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Super Preview Modal -->
@if (superPreviewVisible()) {
  <div class="fixed inset-0 z-[60] bg-black/90 backdrop-blur-sm animate-fade-in" role="dialog" aria-label="Vista ampliada de archivo">
    <div class="h-full flex flex-col">
      <!-- Barra superior -->
      <div class="bg-slate-900/80 px-6 py-4 flex items-center justify-between border-b border-slate-700">
        <span class="text-white font-semibold truncate flex-1">{{ archivo()?.nombre }}</span>
        <div class="flex items-center gap-2">
          @if (archivo()?.tipo === 'application/pdf') {
            <button 
              class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg font-medium transition-colors"
              (click)="abrirEnNuevaPestana()">
              Nueva pestaña
            </button>
          }
          <button 
            class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg font-medium transition-colors"
            (click)="cerrarSuper()">
            Cerrar
          </button>
        </div>
      </div>

      <!-- Contenido -->
      <div class="flex-1 overflow-auto p-4 flex items-center justify-center">
        @if (archivo()?.esImagen && archivo()?.base64) {
          <img class="max-w-full max-h-full object-contain rounded-lg shadow-2xl" [src]="archivo()!.base64" alt="Imagen ampliada" />
        }
        @if (archivo()?.tipo === 'application/pdf') {
          @if (!archivo()?.cargaFallida) {
            <iframe 
              class="w-full h-full rounded-lg shadow-2xl bg-white" 
              [src]="archivo()!.safeUrl" 
              title="PDF ampliado"
              (error)="marcarIframeError()"></iframe>
          } @else {
            <div class="bg-warning-900/50 border border-warning-700 rounded-lg p-8 text-center max-w-md">
              <svg class="w-16 h-16 mx-auto text-warning-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <p class="text-white font-medium mb-4">No se pudo mostrar el PDF</p>
              <button class="px-6 py-2 bg-warning-600 hover:bg-warning-700 text-white rounded-lg font-medium transition-colors" (click)="abrirEnNuevaPestana()">
                Abrir en nueva pestaña
              </button>
            </div>
          }
        }
        @if (!archivo()?.esImagen && archivo()?.tipo !== 'application/pdf') {
          <div class="bg-slate-800 rounded-lg p-8 text-center max-w-md">
            <svg class="w-16 h-16 mx-auto text-slate-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            <p class="text-white mb-4">{{ archivo()?.nombre }}</p>
            <button class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors" (click)="abrirEnNuevaPestana()">
              Abrir / Descargar
            </button>
          </div>
        }
      </div>
    </div>
  </div>
}