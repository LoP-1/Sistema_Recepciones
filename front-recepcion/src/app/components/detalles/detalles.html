<!-- Modal de detalles y evidencias para tr√°mite -->
<header class="modal-header">
  <h2 class="modal-title">Agregar Detalles / Evidencias</h2>
  <div class="header-actions">
    <!-- Bot√≥n Imprimir (solo visible si hay historial) -->
    <button
      type="button"
      class="btn icon only ghost print-btn"
      aria-label="Imprimir constancia del tr√°mite"
      (click)="ImprimirTramite()"
      [disabled]="!historial().length">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M6 9V4h12v5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <rect x="6" y="16" width="12" height="4" rx="1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <rect x="3" y="9" width="18" height="7" rx="2" stroke="currentColor" stroke-width="2"/>
        <circle cx="17" cy="13" r="1" fill="currentColor"/>
      </svg>
    </button>

    <!-- Bot√≥n Cerrar -->
    <button
      type="button"
      class="btn icon only ghost close-btn"
      (click)="cerrar()"
      aria-label="Cerrar">
      ‚úï
    </button>
  </div>
</header>

<div class="modal-body layout-wide">
  <!-- Columna izquierda: Formulario -->
  <form [formGroup]="form" (ngSubmit)="guardar()" class="form" novalidate>
    <!-- Selecci√≥n de tipo de proceso -->
    <div class="field">
      <label for="fTipoProceso">Tipo Proceso <span class="req" aria-hidden="true">*</span></label>
      <select id="fTipoProceso" formControlName="tipoProceso"
        [class.invalid]="form.controls.tipoProceso.touched && form.controls.tipoProceso.invalid"
        [attr.aria-invalid]="form.controls.tipoProceso.touched && form.controls.tipoProceso.invalid || null">
        @for (t of tiposProceso; track t) {
          <option [value]="t">{{ t }}</option>
        }
      </select>
      @if (form.controls.tipoProceso.touched && form.controls.tipoProceso.invalid) {
        <div class="error">Requerido</div>
      }
    </div>

    @if (form.value.tipoProceso === 'Personalizado') {
      <div class="field">
        <label for="fCustomTipoProceso">Nombre de proceso personalizado <span class="req" aria-hidden="true">*</span></label>
        <input id="fCustomTipoProceso" formControlName="customTipoProceso"
          [class.invalid]="form.controls.customTipoProceso.touched && form.controls.customTipoProceso.invalid"
          [attr.aria-invalid]="form.controls.customTipoProceso.touched && form.controls.customTipoProceso.invalid || null"
          placeholder="Ej: Proceso especial" />
        @if (form.controls.customTipoProceso.touched && form.controls.customTipoProceso.invalid) {
          <div class="error">Requerido</div>
        }
      </div>
    }

    <div class="field">
      <label for="fDetalles">Detalles / Descripci√≥n <span class="req" aria-hidden="true">*</span></label>
      <textarea id="fDetalles" rows="4" formControlName="detalles" placeholder="Ej: Se adjunta boleta escaneada..."
        [class.invalid]="form.controls.detalles.touched && form.controls.detalles.invalid"
        [attr.aria-invalid]="form.controls.detalles.touched && form.controls.detalles.invalid || null"></textarea>
      @if (form.controls.detalles.touched && form.controls.detalles.invalid) {
        <div class="error">M√≠nimo 5 caracteres</div>
      }
    </div>

    @if (form.value.tipoProceso === 'Adjunto' || form.value.tipoProceso === 'Personalizado') {
      <div class="field">
        <label for="fBoleta">Boleta (opcional)</label>
        <input id="fBoleta" formControlName="boleta" placeholder="N√∫mero de boleta" />
      </div>
      <div class="field">
        <label for="fMonto">Monto (opcional)</label>
        <input id="fMonto" type="number" min="0" formControlName="monto" placeholder="Ej: 100.00" />
      </div>
    }

    <div class="upload-block">
      <h3 class="section-title">Adjuntar Archivo (Opcional)</h3>
      <div class="drop-wrapper" fileDrop (fileDropped)="onFileDropped($event)" [class.loading]="cargando()">
        @if (!archivo()) {
          <p class="drop-icon" aria-hidden="true">üìé</p>
          <p class="drop-text">Arrastra y suelta aqu√≠ o</p>
          <label class="btn outline small">
            Seleccionar archivo
            <input type="file" (change)="onFileInputChange($event)" hidden />
          </label>
            <p class="help">M√°x {{ (maxSizeBytes / (1024*1024)).toFixed(1) }} MB</p>
        } @else {
          <div class="file-preview">
            <strong class="file-name">{{ archivo()!.nombre }}</strong>
            <small class="file-meta">{{ archivo()!.tipo }} - {{ archivo()!.tamanoKb }} KB</small>

            @if (archivo()!.esImagen && archivo()!.base64) {
              <div class="img-preview">
                <img [src]="archivo()!.base64" alt="Vista previa imagen" />
              </div>
            }

            @if (archivo()!.tipo === 'application/pdf') {
              <div class="pdf-inline-wrapper">
                @if (!archivo()!.cargaFallida) {
                  <iframe class="pdf-inline-frame" [src]="archivo()!.safeUrl" title="Vista previa PDF"
                    (error)="marcarIframeError()" (load)="logExitoPDF()"></iframe>
                } @else {
                  <div class="pdf-fallback">
                    No se puede mostrar el PDF embebido.
                    <button type="button" class="btn outline small" (click)="abrirEnNuevaPestana()">Abrir</button>
                  </div>
                }
              </div>
              <div class="pdf-actions-inline">
                <button type="button" class="btn outline small" (click)="abrirEnNuevaPestana()">Nueva pesta√±a</button>
                <button type="button" class="btn outline small" (click)="abrirSuper()">Ver Grande</button>
              </div>
            }

            @if (!archivo()!.esImagen && archivo()!.tipo !== 'application/pdf') {
              <div class="file-generic" aria-hidden="true">üìÑ</div>
              <button type="button" class="btn outline small" (click)="abrirEnNuevaPestana()">Abrir / Descargar</button>
            }

            <div class="file-actions">
              <button type="button" class="btn danger" (click)="quitarArchivo()">Quitar</button>
              <label class="btn outline small">
                Cambiar
                <input type="file" (change)="onFileInputChange($event)" hidden />
              </label>
            </div>
          </div>
        }
      </div>
    </div>

    @if (mensaje()) {
      <div class="alert" [class.error]="esError()" [class.success]="!esError()" role="status" aria-live="polite">
        @if (esError()) { <span aria-hidden="true">‚ö†Ô∏è</span> } @else { <span aria-hidden="true">‚úÖ</span> }
        {{ mensaje() }}
      </div>
    }
  </form>

  <!-- Columna derecha: L√≠nea de tiempo -->
  <section class="timeline">
    <h3 class="section-title">L√≠nea de tiempo</h3>

    @if (cargandoHistorial()) {
      <div class="loading-inline" aria-live="polite">
        <span class="inline-spinner" aria-hidden="true"></span> Cargando historial...
      </div>
    }

    @for (item of historial(); track item.id) {
      <li class="timeline-item">
        <div class="timeline-row">
          <div class="timeline-date">
            <span aria-hidden="true">üïí</span>
            {{ item.fechaProceso | date:'yyyy-MM-dd HH:mm' }}
          </div>
          <span class="badge" [ngClass]="{
            'badge-finalizado': item.tipoProceso === 'Finalizado',
            'badge-iniciado': item.tipoProceso === 'Iniciado',
            'badge-adjunto': item.tipoProceso === 'Adjunto',
            'badge-azul': item.tipoProceso !== 'Finalizado' && item.tipoProceso !== 'Iniciado' && item.tipoProceso !== 'Adjunto'
          }">
            {{ item.tipoProceso }}
          </span>
        </div>
        <p class="timeline-detalles">{{ item.detalles }}</p>

        @if (item.boleta) {
          <p class="timeline-detalles"><strong>Boleta:</strong> {{ item.boleta }}</p>
        }
        @if (item.monto != null && item.monto !== undefined) {
          <p class="timeline-detalles"><strong>Monto:</strong> {{ 'S/.' + item.monto }}</p>
        }
        @if (item.nombreArchivo) {
          <div class="timeline-file">
            <span aria-hidden="true">üìé</span>
            <span class="file-link">{{ item.nombreArchivo }}</span>
            <button type="button" class="btn ghost small" (click)="descargarAdjunto(item)">Descargar</button>
          </div>
        }
      </li>
    }

    @if (!cargandoHistorial() && !historial().length) {
      <p class="empty">Sin historial de procesos.</p>
    }

    <div class="form-actions vertical-actions">
      <button type="button" class="btn primary" [disabled]="form.invalid || cargando()" (click)="guardar()">
        @if (!cargando()) { Guardar }
        @if (cargando()) { <span class="inline-spinner"></span> }
      </button>
      <button type="button" class="btn outline" (click)="limpiarTodo()" [disabled]="cargando()">Limpiar</button>
      <button type="button" class="btn warn" [disabled]="form.controls.tipoProceso.invalid || cargandoFinalizar()"
        (click)="finalizarTramiteClick()">
        @if (!cargandoFinalizar()) { Finalizar Tr√°mite }
        @if (cargandoFinalizar()) { <span class="inline-spinner"></span> }
      </button>
      <button type="button" class="btn success" (click)="cerrar()">Cerrar</button>
    </div>
  </section>
</div>

@if (superPreviewVisible()) {
  <div class="super-overlay" role="dialog" aria-label="Vista ampliada de archivo">
    <div class="super-bar">
      <span class="title">{{ archivo()?.nombre }}</span>
      <div class="actions">
        @if (archivo()?.tipo === 'application/pdf') {
          <button class="btn outline small" (click)="abrirEnNuevaPestana()">Nueva pesta√±a</button>
        }
        <button class="btn ghost small" (click)="cerrarSuper()">Cerrar</button>
      </div>
    </div>
    <div class="super-content">
      @if (archivo()?.esImagen && archivo()?.base64) {
        <img class="super-img" [src]="archivo()!.base64" alt="Imagen ampliada" />
      }
      @if (archivo()?.tipo === 'application/pdf') {
        @if (!archivo()?.cargaFallida) {
          <iframe class="super-pdf-frame" [src]="archivo()!.safeUrl" title="PDF ampliado"
            (error)="marcarIframeError()"></iframe>
        } @else {
          <div class="pdf-fallback">
            No se pudo mostrar el PDF embebido.
            <button class="btn outline small" (click)="abrirEnNuevaPestana()">Abrir en nueva pesta√±a</button>
          </div>
        }
      }
      @if (!archivo()?.esImagen && archivo()?.tipo !== 'application/pdf') {
        <p class="fallback-generic">
          Archivo: {{ archivo()?.nombre }}<br />
          <button type="button" class="btn outline small" (click)="abrirEnNuevaPestana()">Abrir / Descargar</button>
        </p>
      }
    </div>
  </div>
}