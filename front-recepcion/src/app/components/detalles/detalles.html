<header class="modal-header">
  <h2 class="modal-title">Agregar Detalles / Evidencias</h2>
  <button type="button" class="btn icon only" (click)="cerrar()" aria-label="Cerrar">‚úï</button>
</header>

<div class="modal-body layout-wide">
  <form [formGroup]="form" (ngSubmit)="guardar()" novalidate class="form">
    <div class="field">
      <label for="fIdTramite">ID Tr√°mite <span class="req">*</span></label>
      <input id="fIdTramite" type="number" formControlName="idTramite" min="1"
        [class.invalid]="form.controls.idTramite.touched && form.controls.idTramite.invalid" />
      <div class="error" *ngIf="form.controls.idTramite.touched && form.controls.idTramite.invalid">Ingrese un ID v√°lido
      </div>
    </div>

    <div class="field">
      <label for="fTipoProceso">Tipo Proceso <span class="req">*</span></label>
      <select id="fTipoProceso" formControlName="tipoProceso"
        [class.invalid]="form.controls.tipoProceso.touched && form.controls.tipoProceso.invalid">
        <option *ngFor="let t of tiposProceso" [value]="t">{{ t }}</option>
      </select>
      <div class="error" *ngIf="form.controls.tipoProceso.touched && form.controls.tipoProceso.invalid">Requerido</div>
    </div>

    <div class="field">
      <label for="fDetalles">Detalles / Descripci√≥n <span class="req">*</span></label>
      <textarea id="fDetalles" rows="4" formControlName="detalles" placeholder="Ej: Se adjunta boleta escaneada..."
        [class.invalid]="form.controls.detalles.touched && form.controls.detalles.invalid"></textarea>
      <div class="error" *ngIf="form.controls.detalles.touched && form.controls.detalles.invalid">M√≠nimo 5 caracteres
      </div>
    </div>

    <div class="upload-block">
      <h3 class="section-title">Adjuntar Archivo (Opcional)</h3>
      <div class="drop-wrapper" fileDrop (fileDropped)="onFileDropped($event)">
        <ng-container *ngIf="!archivo(); else filePreview">
          <p class="drop-icon">üìé</p>
          <p class="drop-text">Arrastra y suelta aqu√≠ o</p>
          <label class="btn outline small">
            Seleccionar archivo
            <input type="file" (change)="onFileInputChange($event)" accept="image/*,.pdf,.jpg,.jpeg,.png" hidden />
          </label>
          <p class="help">M√°x {{ (maxSizeBytes / (1024*1024)).toFixed(1) }} MB</p>
        </ng-container>
        <ng-template #filePreview>
          <div class="file-preview">
            <strong class="file-name">{{ archivo()!.nombre }}</strong>
            <small class="file-meta">{{ archivo()!.tipo }} - {{ archivo()!.tamanoKb }} KB</small>
            <div *ngIf="archivo()!.esImagen && archivo()!.base64" class="img-preview">
              <img [src]="archivo()!.base64" alt="Vista previa" />
            </div>
            <div *ngIf="!archivo()!.esImagen" class="file-generic">üìÑ</div>
            <div class="file-actions">
              <button type="button" class="btn danger" (click)="quitarArchivo()">Quitar</button>
              <label class="btn outline small">
                Cambiar
                <input type="file" (change)="onFileInputChange($event)" accept="image/*,.pdf,.jpg,.jpeg,.png" hidden />
              </label>
            </div>
          </div>
        </ng-template>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn primary" [disabled]="form.invalid || cargando()">
        <span *ngIf="!cargando()">Guardar</span>
        <span *ngIf="cargando()" class="inline-spinner" aria-hidden="true"></span>
      </button>

      <button type="button" class="btn outline" (click)="limpiarTodo()" [disabled]="cargando()">Limpiar</button>
      <button type="button" class="btn ghost" (click)="cerrar()">Cerrar</button>
      <button type="button" class="btn finalizar" [disabled]="form.controls.idTramite.invalid || cargandoFinalizar()"
        (click)="finalizarTramiteClick()">
        <span *ngIf="!cargandoFinalizar()">Finalizar Tr√°mite</span>
        <span *ngIf="cargandoFinalizar()" class="inline-spinner" aria-hidden="true"></span>
      </button>
    </div>

    <div class="alert" *ngIf="mensaje()" [class.error]="esError()" role="status" aria-live="polite">
      <span *ngIf="esError()">‚ö†Ô∏è</span>
      <span *ngIf="!esError()">‚úÖ</span>
      {{ mensaje() }}
    </div>
  </form>

  <section class="timeline">
    <h3 class="section-title">L√≠nea de tiempo</h3>
    <div *ngIf="cargandoHistorial()" class="loading-inline" aria-live="polite">
      <span class="inline-spinner" aria-hidden="true"></span> Cargando historial...
    </div>
    <ul class="timeline-list" *ngIf="!cargandoHistorial() && historial().length">
      <li *ngFor="let item of historial()" class="timeline-item">
        <div class="timeline-row">
          <div class="timeline-date">
            <span aria-hidden="true">üïí</span>
            {{ item.fechaProceso | date:'yyyy-MM-dd HH:mm' }}
          </div>
          <span class="badge" [ngClass]="{
    'badge-finalizado': item.tipoProceso === 'Finalizado',
    'badge-iniciado': item.tipoProceso === 'Iniciado',
    'badge-adjunto': item.tipoProceso === 'Adjunto',
    'badge-azul': item.tipoProceso !== 'Finalizado' && item.tipoProceso !== 'Iniciado' && item.tipoProceso !== 'Adjunto'
  }">
            {{ item.tipoProceso }}
          </span>
        </div>
        <p class="timeline-detalles">{{ item.detalles }}</p>
        <div *ngIf="item.nombreArchivo" class="timeline-file">
          <span aria-hidden="true">üìé</span>
          <span class="file-link">{{ item.nombreArchivo }}</span>
          <button type="button" class="btn ghost small" (click)="descargarAdjunto(item)">Descargar</button>
        </div>
      </li>
    </ul>
    <p *ngIf="!cargandoHistorial() && !historial().length" class="empty" aria-live="polite">
      Sin historial de procesos.
    </p>
  </section>
</div>